{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Bulk Schedule Creation - {{ route }}{% endblock %}

{% block extrastyle %}
    <style>
        .form-row { margin-bottom: 15px; }
        .form-group { display: inline-block; margin-right: 20px; vertical-align: top; }
        .help-text { color: #666; font-size: 12px; }
        .operational-days { display: flex; flex-wrap: wrap; gap: 10px; }
        .operational-days label { display: flex; align-items: center; gap: 5px; }
        .schedule-preview { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .route-info { background: #e3f2fd; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">Home</a>
&rsaquo; <a href="{% url 'admin:routes_route_changelist' %}">Routes</a>
&rsaquo; Bulk Schedule Creation - {{ route }}
</div>
{% endblock %}

{% block content %}
<div class="route-info">
    <h2>Route Information</h2>
    <p><strong>Route:</strong> {{ route.from_destination.name }} ({{ route.from_destination.code }}) â†’ {{ route.to_destination.name }} ({{ route.to_destination.code }})</p>
    <p><strong>Price:</strong> {{ route.price }} {{ route.currency }}</p>
    <p><strong>Estimated Duration:</strong> {{ route.estimated_time }}</p>
    <p><strong>Distance:</strong> {{ route.distance }} km</p>
</div>

<form method="post" id="bulk-schedule-form">
    {% csrf_token %}
    
    <h2>Schedule Parameters</h2>
    
    <fieldset class="module aligned">
        <div class="form-row">
            <div class="form-group">
                <label for="flight_number">Flight Number:</label>
                <input type="text" id="flight_number" name="flight_number" placeholder="Auto-generate if empty">
                <p class="help-text">Leave empty to auto-generate (e.g., FJ{{ route.from_destination.code }}{{ route.to_destination.code }}01)</p>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="departure_time">Departure Time:</label>
                <input type="time" id="departure_time" name="departure_time" required>
            </div>
            <div class="form-group">
                <label for="flight_duration_hours">Flight Duration (Hours):</label>
                <input type="number" id="flight_duration_hours" name="flight_duration_hours" value="2" min="1" max="24">
            </div>
            <div class="form-group">
                <label for="flight_duration_minutes">Flight Duration (Minutes):</label>
                <input type="number" id="flight_duration_minutes" name="flight_duration_minutes" value="0" min="0" max="59">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="total_seats">Total Seats:</label>
                <input type="number" id="total_seats" name="total_seats" value="150" min="1">
            </div>
            <div class="form-group">
                <label for="price_multiplier">Price Multiplier:</label>
                <input type="number" id="price_multiplier" name="price_multiplier" value="1.00" step="0.01" min="0.5" max="3.0">
                <p class="help-text">Base price: {{ route.price }} {{ route.currency }}</p>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="module aligned">
        <h3>Operational Days</h3>
        <div class="operational-days">
            <label><input type="checkbox" name="operational_days" value="0"> Monday</label>
            <label><input type="checkbox" name="operational_days" value="1"> Tuesday</label>
            <label><input type="checkbox" name="operational_days" value="2"> Wednesday</label>
            <label><input type="checkbox" name="operational_days" value="3"> Thursday</label>
            <label><input type="checkbox" name="operational_days" value="4"> Friday</label>
            <label><input type="checkbox" name="operational_days" value="5"> Saturday</label>
            <label><input type="checkbox" name="operational_days" value="6"> Sunday</label>
        </div>
        <p class="help-text">Leave unchecked to create schedules for all days in the date range.</p>
    </fieldset>
    
    <div class="schedule-preview" id="preview" style="display: none;">
        <h3>Preview</h3>
        <p id="preview-text"></p>
    </div>
    
    <div class="submit-row">
        <input type="submit" value="Create Schedules" class="default">
        <a href="{% url 'admin:routes_route_changelist' %}" class="button cancel-link">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulk-schedule-form');
    const preview = document.getElementById('preview');
    const previewText = document.getElementById('preview-text');
    
    function updatePreview() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const departureTime = document.getElementById('departure_time').value;
        const operationalDays = Array.from(document.querySelectorAll('input[name="operational_days"]:checked')).map(cb => cb.value);
        const priceMultiplier = parseFloat(document.getElementById('price_multiplier').value || 1);
        
        if (startDate && endDate && departureTime) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            let scheduleCount = 0;
            let currentDate = new Date(start);
            
            while (currentDate <= end) {
                const weekday = currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1; // Convert Sunday=0 to Sunday=6
                
                if (operationalDays.length === 0 || operationalDays.includes(weekday.toString())) {
                    scheduleCount++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const basePrice = {{ route.price|floatformat:2 }};
            const finalPrice = (basePrice * priceMultiplier).toFixed(2);
            
            const opDaysText = operationalDays.length === 0 ? 'All days' : operationalDays.map(d => dayNames[d]).join(', ');
            
            previewText.innerHTML = `
                <strong>Schedules to create:</strong> ${scheduleCount}<br>
                <strong>Date range:</strong> ${startDate} to ${endDate}<br>
                <strong>Departure time:</strong> ${departureTime}<br>
                <strong>Operational days:</strong> ${opDaysText}<br>
                <strong>Price per ticket:</strong> ${finalPrice} {{ route.currency }}
            `;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }
    
    // Add event listeners for real-time preview
    const inputs = ['start_date', 'end_date', 'departure_time', 'price_multiplier'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('change', updatePreview);
    });
    
    document.querySelectorAll('input[name="operational_days"]').forEach(cb => {
        cb.addEventListener('change', updatePreview);
    });
    
    // Set default start date to today
    document.getElementById('start_date').value = new Date().toISOString().split('T')[0];
    
    // Set default end date to one month from today
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.getElementById('end_date').value = nextMonth.toISOString().split('T')[0];
    
    updatePreview();
});
</script>
{% endblock %}